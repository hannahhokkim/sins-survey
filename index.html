<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seven Deadly Sins Survey</title>

  <!-- jsPsych CSS -->
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" />

  <!-- jsPsych core -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>

  <!-- Plugin used for a single "wizard" trial -->
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width: 820px; margin: 24px auto; padding: 0 8px; }
    .small { opacity: .75; font-size: 13px; line-height: 1.35; }
    .heroimg { width: 100%; max-width: 760px; height: auto; border-radius: 12px; display: block; margin: 14px auto; }
    canvas { max-width:520px; width:100%; height:auto; }
    .row { margin: 12px 0; padding: 10px 12px; border: 1px solid rgba(0,0,0,0.12); border-radius: 12px; }
    .lab { display:flex; justify-content:space-between; gap:10px; font-size:14px; font-weight:700; }
    .choices { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    .chip {
      display:inline-flex; align-items:center; gap:6px;
      border: 1px solid rgba(0,0,0,0.20);
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
      user-select: none;
      font-weight: 650;
      font-size: 13px;
    }
    .chip input { cursor:pointer; }
    button {
      padding:10px 14px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.25);
      cursor:pointer;
      font-weight:800;
      background: #fff;
    }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .nav { margin-top: 16px; display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .nav-right { display:flex; justify-content:flex-end; gap:10px; align-items:center; }
    textarea { width:100%; min-height: 120px; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.2); }
    .err { color: #b00020; font-weight: 700; margin-top: 10px; }
    .ok { color: #0b6b0b; font-weight: 700; margin-top: 10px; }
    a { color: inherit; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <div id="jspsych-target"></div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxwsBRZMjrQFFEqJ-sedLhqJg-DVNwQ6JTR1OwVLyV52GgTbtD0H2WmROGoyZ1rcA3e/exec";

    const SINS = [
      { id: "pride", label: "Pride" },
      { id: "greed", label: "Greed" },
      { id: "lust", label: "Lust" },
      { id: "envy", label: "Envy" },
      { id: "gluttony", label: "Gluttony" },
      { id: "wrath", label: "Wrath" },
      { id: "sloth", label: "Sloth" },
    ];

    const SLIDO_URL = "https://app.sli.do/event/mVxRttUV7vKSqaJcFkjaNV/polls";

    // =========================
    // PARTICIPANT ID
    // (kept stable per browser; multiple submissions are allowed)
    // =========================
    function getParticipantId() {
      let pid = localStorage.getItem("participant_id");
      if (!pid) {
        pid = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2));
        localStorage.setItem("participant_id", pid);
      }
      return pid;
    }

    async function postToSheets(payload) {
      payload.participant_id = getParticipantId();
      payload.timestamp = new Date().toISOString();
      payload.user_agent = navigator.userAgent;

      // Use text/plain to avoid CORS preflight hassles
      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error("POST failed: " + res.status);
      return res;
    }

    // =========================
    // WIZARD STATE
    // =========================
    const state = {
      step: 0,
      // radar values stored as numbers 1-7, or null if not set
      radar: Object.fromEntries(SINS.map(s => [s.id, null])),
      sun: [],
      moon: [],
      rising: [],
      who: "",
      // submission status
      lastSaveOk: false
    };

    const steps = ["intro", "radar", "slido", "sun_moon_rising", "who", "done"];

    // =========================
    // HTML HELPERS
    // =========================
    function esc(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function sinCheckboxGroup(name, selectedArr) {
      const opts = SINS.map(s => {
        const checked = selectedArr.includes(s.label) ? "checked" : "";
        const id = `${name}_${s.id}`;
        return `
          <label class="chip" for="${id}">
            <input id="${id}" type="checkbox" name="${name}" value="${esc(s.label)}" ${checked}>
            ${esc(s.label)}
          </label>
        `;
      }).join("");
      return `<div class="choices">${opts}</div>`;
    }

    function radarRowsHTML() {
      // Radio buttons allow truly "unset" (none selected) at load.
      return SINS.map(s => {
        const val = state.radar[s.id];
        const display = (val == null) ? "" : String(val);

        const radios = [1,2,3,4,5,6,7].map(n => {
          const id = `${s.id}_r_${n}`;
          const checked = (val === n) ? "checked" : "";
          return `
            <label class="chip" for="${id}">
              <input type="radio" id="${id}" name="${s.id}" value="${n}" ${checked}>
              ${n}
            </label>
          `;
        }).join("");

        return `
          <div class="row">
            <div class="lab">
              <span>${esc(s.label)}</span>
              <span id="${s.id}_val">${esc(display)}</span>
            </div>
            <div class="choices" role="radiogroup" aria-label="${esc(s.label)}">
              ${radios}
            </div>
          </div>
        `;
      }).join("");
    }

    function navHTML({ backDisabled, nextLabel }) {
      return `
        <div class="nav">
          <div>
            <button id="backBtn" type="button" ${backDisabled ? "disabled" : ""}>Back</button>
          </div>
          <div class="nav-right">
            <span id="status" class="small"></span>
            <button id="nextBtn" type="button">${esc(nextLabel)}</button>
          </div>
        </div>
      `;
    }

    // =========================
    // RENDER STEPS
    // =========================
    let chart = null;

    function render() {
      const stepName = steps[state.step];
      const root = document.getElementById("wizardRoot");
      if (!root) return;

      if (stepName === "intro") {
        root.innerHTML = `
          <div class="wrap">
            <img class="heroimg" src="Yates.png" alt="Yates Thompson manuscript">
            <div class="small">Personifications of the Seven Deadly Sins in a fourteenth-century manuscript (British Library, Yates Thompson MS. 21, f. 165</div>

            <div style="height: 14px;"></div>

            <div style="white-space: pre-wrap;">
Have been tasked yet again as the hermeneutic theorypilled factcel social scientist within the household with creating a survey to make you mingle and also collect information on you. Last time a few of you expressed discontent with <a href="https://harvard.az1.qualtrics.com/jfe/form/SV_b4rtiUbvYuTrr7w" target="_blank" rel="noopener noreferrer">my bday survey</a> that our great failing american institute Harvard University may have access to your data and strange body facts. Your feedback has been taken into consideration. Now the only entity that will have your data other than the windsor household is sundar pichai the CEO of google via the extremely secure google sheets link that is attached to this survey. 

This is my first time making a jsPsych survey and i will admit that i am very, very, very afraid that it will fail :( this survey will have 3 parts. Please fill out as much or as little as you deem appropriate. The main section of this survey will be envy. We are about to get sooooo super covetous in da house tonight 
            </div>

            ${navHTML({ backDisabled: true, nextLabel: "Continue" })}
          </div>
        `;
        wireNav();
        return;
      }

      if (stepName === "radar") {
        root.innerHTML = `
          <div class="wrap">
            <h2 style="margin-top:0;">SINSTATS</h2>

            <img class="heroimg" src="Peraldus.png" alt="Peraldus Treatise on the Vices">
            <div class="small">Summa de vitiis or "Treatise on the Vices" by the 13th-century Dominican friar William Peraldus</div>

            <div style="height: 14px;"></div>

            <div style="white-space: pre-wrap;">
First things first, rate ur stats on each sin. 1 is low, 7 is high.
            </div>

            <div style="height: 10px;"></div>

            <div style="display:flex; justify-content:center;">
              <canvas id="radarChart" width="400" height="400"></canvas>
            </div>

            ${radarRowsHTML()}

            <div id="radarErr" class="err" style="display:none;">Please set all seven values before continuing.</div>

            ${navHTML({ backDisabled: false, nextLabel: "Continue" })}
          </div>
        `;

        initRadarChart();
        wireRadarInputs();
        wireNav({
          onNext: () => {
            const allSet = SINS.every(s => Number.isInteger(state.radar[s.id]));
            const err = document.getElementById("radarErr");
            if (!allSet) {
              err.style.display = "block";
              return false;
            }
            err.style.display = "none";
            return true;
          }
        });
        return;
      }

      if (stepName === "slido") {
        root.innerHTML = `
          <div class="wrap">
            <h2 style="margin-top:0;">ENVY ! COVET ! WANT ! WANT ! WANT !</h2>

            <div class="small" style="margin-bottom:10px;">
Struggling with envy? <a href="https://www.catholictradition.org/Classics/guide33.htm" target="_blank" rel="noopener noreferrer"> You’re not the only one.
  </a> List some things you've been envious of in the past and see what the other party-goers agree on. I was too lazy to code this myself so enjoy this slido url based activity. link highly recommended that you do open. 
            </div>

               <div class="small" style="margin-bottom:10px;">
                        If the poll doesn’t load, open it here:
              <a href="${esc(SLIDO_URL)}" target="_blank" rel="noopener noreferrer">Open Slido in a new tab</a>
            </div>

            <iframe
              src="${esc(SLIDO_URL)}"
              style="width:100%; min-height:720px; border:0; border-radius:12px;"
              allow="clipboard-write; fullscreen"
              loading="lazy"
            ></iframe>

            ${navHTML({ backDisabled: false, nextLabel: "Continue" })}
          </div>
        `;
        wireNav();
        return;
      }

      if (stepName === "sun_moon_rising") {
        root.innerHTML = `
          <div class="wrap">
            <img class="heroimg" src="ensor.png" alt="James Ensor, The Deadly Sins Dominated by Death">
            <div class="small">
              James Ensor, <em>The Deadly Sins Dominated by Death</em>, hand-coloured etching on Japanese paper, frontispiece to <em>The Deadly Sins</em>, ca. 1904
            </div>

            <div style="height: 10px;"></div>

            <div style="white-space: pre-wrap;">
The question that i believe sparked the party theme. Slightly different than just raw stats - we want to know what your sun moon and rising are for the seven deadly sins.

SUN - Your core, your impulse, the thing that sheds light on everything else.
MOON - Your emotional self.
RISING - How people see and experience you.
            </div>

            <div style="height: 14px;"></div>

            <div class="row">
              <div class="lab"><span>SUN</span></div>
              ${sinCheckboxGroup("sun", state.sun)}
            </div>

            <div class="row">
              <div class="lab"><span>MOON</span></div>
              ${sinCheckboxGroup("moon", state.moon)}
            </div>

            <div class="row">
              <div class="lab"><span>RISING</span></div>
              ${sinCheckboxGroup("rising", state.rising)}
            </div>

            ${navHTML({ backDisabled: false, nextLabel: "Continue" })}
          </div>
        `;

        wireSMR();
        wireNav();
        return;
      }

      if (stepName === "who") {
        root.innerHTML = `
          <div class="wrap">
            <h2 style="margin-top:0;">Who are you?</h2>
            <p>Feel free to put your name for the game + our records.</p>

            <textarea id="whoBox" placeholder="(optional)">${esc(state.who)}</textarea>

            ${navHTML({ backDisabled: false, nextLabel: "Submit" })}
            <div id="submitErr" class="err" style="display:none;"></div>
            <div id="submitOk" class="ok" style="display:none;"></div>
          </div>
        `;

        document.getElementById("whoBox").addEventListener("input", (e) => {
          state.who = e.target.value;
        });

        wireNav({
          onNext: async () => {
            const status = document.getElementById("status");
            const err = document.getElementById("submitErr");
            const ok = document.getElementById("submitOk");
            err.style.display = "none";
            ok.style.display = "none";

            status.textContent = "Saving…";

            const payload = {
              stage: "final",
              pride: state.radar.pride,
              greed: state.radar.greed,
              lust: state.radar.lust,
              envy: state.radar.envy,
              gluttony: state.radar.gluttony,
              wrath: state.radar.wrath,
              sloth: state.radar.sloth,
              sun: state.sun.join("; "),
              moon: state.moon.join("; "),
              rising: state.rising.join("; "),
              who: state.who || "",
              slido_url: SLIDO_URL,
              all_trials_json: JSON.stringify({
                radar: state.radar,
                sun: state.sun,
                moon: state.moon,
                rising: state.rising,
                who: state.who
              })
            };

            try {
              await postToSheets(payload);
              status.textContent = "Saved.";
              ok.style.display = "block";
              ok.textContent = "Saved. Thanks.";
              state.lastSaveOk = true;
              return true;
            } catch (e) {
              console.error(e);
              status.textContent = "";
              err.style.display = "block";
              err.textContent = "Save failed. Check console / Apps Script logs.";
              state.lastSaveOk = false;
              return false; // keep them on this page
            }
          }
        });

        return;
      }

      if (stepName === "done") {
        root.innerHTML = `
          <div class="wrap">
            <h2 style="margin-top:0;">Done</h2>
            <p>You can close this tab.</p>
            <p class="small">Participant ID (browser): <code>${esc(getParticipantId())}</code></p>
            <p class="small">If you refill the survey, it will create another row in the sheet.</p>
          </div>
        `;
        return;
      }
    }

    // =========================
    // WIRING: NAV + INPUTS
    // =========================
    function wireNav(opts = {}) {
      const backBtn = document.getElementById("backBtn");
      const nextBtn = document.getElementById("nextBtn");

      if (backBtn) {
        backBtn.addEventListener("click", () => {
          if (state.step > 0) {
            state.step -= 1;
            render();
          }
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener("click", async () => {
          if (opts.onNext) {
            const ok = await opts.onNext();
            if (!ok) return;
          }
          if (state.step < steps.length - 1) {
            state.step += 1;
            render();
          }
        });
      }
    }

    function initRadarChart() {
      const ctx = document.getElementById("radarChart");
      if (!ctx) return;

      chart = new Chart(ctx, {
        type: "radar",
        data: {
          labels: SINS.map(s => s.label),
          datasets: [{
            label: "You",
            data: SINS.map(s => state.radar[s.id]), // nulls allowed
            fill: true
          }]
        },
        options: {
          responsive: true,
          animation: false,
          spanGaps: false,
          scales: {
            r: {
              min: 1,
              max: 7,
              ticks: { stepSize: 1 }
            }
          }
        }
      });

      updateRadarChart();
    }

    function updateRadarChart() {
      if (!chart) return;
      chart.data.datasets[0].data = SINS.map(s => state.radar[s.id]);
      chart.update();
    }

    function wireRadarInputs() {
      SINS.forEach(s => {
        const radios = document.querySelectorAll(`input[type="radio"][name="${s.id}"]`);
        radios.forEach(r => {
          r.addEventListener("change", (e) => {
            const v = Number(e.target.value);
            state.radar[s.id] = v;
            const valEl = document.getElementById(`${s.id}_val`);
            if (valEl) valEl.textContent = String(v);
            updateRadarChart();
          });
        });

        const valEl = document.getElementById(`${s.id}_val`);
        if (valEl) valEl.textContent = (state.radar[s.id] == null) ? "" : String(state.radar[s.id]);
      });

      updateRadarChart();
    }

    function wireSMR() {
      ["sun", "moon", "rising"].forEach(group => {
        const boxes = document.querySelectorAll(`input[type="checkbox"][name="${group}"]`);
        boxes.forEach(b => {
          b.addEventListener("change", () => {
            const chosen = Array.from(document.querySelectorAll(`input[type="checkbox"][name="${group}"]:checked`))
              .map(x => x.value);
            state[group] = chosen;
          });
        });
      });
    }

    // =========================
    // INIT jsPsych
    // =========================
    const jsPsych = initJsPsych({
      display_element: "jspsych-target",
    });

    const wizardTrial = {
      type: jsPsychHtmlKeyboardResponse,
      choices: "NO_KEYS",
      stimulus: `<div id="wizardRoot"></div>`,
      on_load: () => {
        render();
      },
      on_finish: () => {
        jsPsych.data.write({
          participant_id: getParticipantId(),
          radar: JSON.stringify(state.radar),
          sun: state.sun.join("; "),
          moon: state.moon.join("; "),
          rising: state.rising.join("; "),
          who: state.who || "",
          lastSaveOk: state.lastSaveOk ? 1 : 0
        });
      }
    };

    jsPsych.run([wizardTrial]);
  </script>
</body>
</html>
